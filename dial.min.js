/*
 * 转盘游戏
 *
 * author: billchen(48838096@qq.com)
 * website: http://www.xhyo.com/
 * date: 2016.05.30
 *
 */
;
(function(window){"use strict"
var prefixs=['webkit','moz','ms','o'];if(!window.requestAnimationFrame){for(var i=0;i<prefixs.length;i++){if(window[prefixs[i]+'RequestAnimationFrame']){window.requestAnimationFrame=requestAnimationFrame=window[prefixs[i]+'RequestAnimationFrame'];window.cancelAnimationFrame=cancelAnimationFrame=window[prefixs[i]+'CancelAnimationFrame'];break;}}
if(!window.requestAnimationFrame){window.requestAnimationFrame=requestAnimationFrame=function(fn){window.setTimeout(fn,1000/60);}
window.cancelAnimationFrame=cancelAnimationFrame=window.clearTimeout;}}
function Dial(option){var canvas=null,_this=this;if(!option.length||!option.image)
return;if(option.canvasId){canvas=document.getElementById(option.canvasId);}
if(!canvas)
throw new Exception('no canvas.');this.width=canvas.width=option.width||document.documentElement.clientWidth;this.height=canvas.height=option.height||document.documentElement.clientWidth;this.duration=option.duration||2000;this.rounds=option.rounds||3;this.length=parseInt(option.length,10);this.startDegree=option.degree||0;this.ctx=canvas.getContext('2d');this.ctx.translate(this.width/2,this.height/2);this.state=0;this.event={};if(typeof option.onready=='function')
this.event.onready=option.onready.bind(this);if(typeof option.onroundend=='function')
this.event.onroundend=option.onroundend.bind(this);if(typeof option.onend=='function')
this.event.onend=option.onend.bind(this);this.image=new Image();this.image.onload=function(e){if(_this.event.onready)
_this.event.onready();_this.reset();};this.image.src=option.image;};Dial.prototype.reset=function(){this.state=1;if(this.animationId)
window.cancelAnimationFrame(this.animationId);this.degree=this.startDegree;this.index=0;this.finishDegree=-1;this.counter=0;this.animationId=0;var x=-this.width/2,y=-this.height/2;try{this.ctx.clearRect(x,y,this.width,this.height);this.ctx.drawImage(this.image,0,0,this.image.width/2,this.image.height,x,y,this.width,this.height);this.ctx.drawImage(this.image,this.image.width/2,0,this.image.width/2,this.image.height,x,y,this.width,this.height);}catch(e){alert(e.message)}};Dial.prototype.start=function(index){if(this.state!==1){return;}
this.state=2;var _this=this,x=-this.width/2,y=-this.height/2,startTime=Date.now();if(index!=undefined){this.finishDegree=this.rounds+(index%this.length+.5)/this.length;}else{this.finishDegree=-1;}
this.counter=0;this.currentDuration=this.duration;function draw(){var time=Date.now(),degree=(time-startTime)/_this.currentDuration,isEnd=false;if(degree>=1){_this.counter++;startTime=time;degree=_this.degree+=1;if(_this.event.onroundend)
_this.event.onroundend();}else
degree=_this.degree+degree;if(_this.finishDegree>-1&&degree>=_this.finishDegree){_this.state=1;isEnd=true;degree=_this.degree=_this.finishDegree%1;}else
degree=degree%1;_this.index=Math.floor(degree*_this.length);_this.ctx.save();_this.ctx.clearRect(x,y,_this.width,_this.height);_this.ctx.drawImage(_this.image,0,0,_this.image.width/2,_this.image.height,x,y,_this.width,_this.height);_this.ctx.rotate(degree*Math.PI*2);_this.ctx.drawImage(_this.image,_this.image.width/2,0,_this.image.width/2,_this.image.height,x,y,_this.width,_this.height);_this.ctx.restore();if(!isEnd)
_this.animationId=window.requestAnimationFrame(draw);else
_this.event.onend();};draw();};Dial.prototype.stop=function(index){if(this.state!==2){return;}
this.state=3;if(index!=undefined){this.finishDegree=this.counter+this.rounds+(index%this.length+.5)/this.length;}else{this.finishDegree=(this.index+.5)/this.length;}};window.dial=function(option){return new Dial(option);};})(window);

